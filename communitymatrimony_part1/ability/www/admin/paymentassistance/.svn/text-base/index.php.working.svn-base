<?php
#====================================================================================================
# Author 		: A.Kirubasankar
# Start Date	: 08 Oct 2009
# End Date		: 20 Aug 2008
# Module		: Payment Assistance
#====================================================================================================

//BASE PATH
$varRootBasePath = '/home/product/community';

//FILE INCLUDES
include_once($varRootBasePath.'/www/admin/includes/config.php');
include_once($varRootBasePath.'/conf/dbinfo.inc');
include_once($varRootBasePath.'/conf/config.inc');
include_once($varRootBasePath.'/conf/payment.inc');
include_once($varRootBasePath.'/lib/clsDB.php');
include_once($varRootBasePath.'/conf/domainlist.inc');
include_once($varRootBasePath.'/conf/vars.inc');
include_once('pavars.inc');

global $adminUserName;
if($adminUserName == "")
	header("Location: ../index.php?act=login");

//OBJECT DECLARTION
$objMaster	= new DB;
$objSlave	= new DB;
$objSlaveMatri = new DB;

//Connecting communitymatrimony db
$objSlaveMatri -> dbConnect('S',$varDbInfo['DATABASE']);

global $varDBUserName, $varDBPassword;
$varDBUserName = $varPaymentAssistanceDbInfo['USERNAME'];
$varDBPassword = $varPaymentAssistanceDbInfo['PASSWORD'];

//Conecting cbssupportiface db
$objSlave-> dbConnect('S',$varPaymentAssistanceDbInfo['DATABASE']);
$objMaster-> dbConnect('M',$varPaymentAssistanceDbInfo['DATABASE']);


//// Vars
global $leadsource,$paymentoption_followup_status;
$OtherISD = $DubaiISDcode+$IndaiISDcode+$UsaISDcode+$AustraliaISDcode+$SingaporeISDcode+$MalaysiaISDcode+$UKISDcode+$CanadaISDcode;


//// Supporting Functions
function validchecking($matriid) //return values if matriid is valid.
{
	global $objSlave,$varTable,$varDbInfo,$objSlaveMatri;

	$args = array('MatriId','Country','Expiry_Date','Paid_Status');
	$argCondition = " WHERE MatriId='".$matriid."'";
//	$checkResult = $objSlaveMatri -> select($varTable['MEMBERINFO'],$args,$argCondition,0);
	$checkResult = $objSlaveMatri -> select($varDbInfo['DATABASE'].".".$varTable['MEMBERINFO'],$args,$argCondition,0);

	if($objSlave -> clsErrorCode != "SELECT_ERR")
	{
		$rsltArr = mysql_fetch_assoc($checkResult);

		if ($rsltArr[MatriId]=='')  return "0";
		else
			 return $returnvariables=$rsltArr[Country]."~".$rsltArr[Paid_Status]."~".$rsltArr[Expiry_Date];
	}
	else
		return "error";
}
function showDomains()
{
	global $arrPrefixDomainList, $arrMatriIdPre;
	$arrMatriIdPre1 = array_flip($arrMatriIdPre);
	$showDomains .= "<select name='domain[]' size='3' multiple class='select'>";
	$showDomains .= "<option value='All'";
	if(is_array($_REQUEST[domain]))
	{
		if(in_array("All",$_REQUEST[domain]))
			$showDomains .= " selected ";
	}
	else
	{
		if($key == db_escape_quotes($_REQUEST[domain]))
			$showDomains .= " selected ";
	}
	$showDomains .= "> --- All ---    </option>";
	foreach($arrPrefixDomainList as $key => $value)
	{
		$numKey = $arrMatriIdPre1[$key];
		$showDomains .= "<option value='".$numKey."'";
		if(is_array($_REQUEST[domain]))
		{
			if(in_array($numKey,$_REQUEST[domain]))
				$showDomains .= " selected ";
		}
		else
		{
			if($key == db_escape_quotes($_REQUEST[domain]))
				$showDomains .= " selected ";
		}
		$showDomains .= ">$value</option>";
	}
	$showDomains .= "</select>";
return $showDomains;
}
function fromdate_todate_payment($formname)
{
	if($formname == "form2")
	{
		$fromDateValue = db_escape_quotes($_REQUEST['fromdate']);
		if($fromDateValue == "")
			$fromDateValue = date("Y-m-d",time());
		$toDateValue = db_escape_quotes($_REQUEST['todate']);
		if($toDateValue == "")
			$toDateValue = date("Y-m-d",time());
		$fromdate_todate_payment = '<td align="right" class="smalltxt">From Date:<br><br>To Date:</td><td>';
		$fromdate_todate_payment .= '<input type="text" name="fromdate"  value="'.$fromDateValue.'" readonly style="width:120px;" class=\'inputtext\' onclick="displayDatePicker(\'fromdate\', \'\', \'ymd\', \'-\');"  HIDEFOCUS><br><br><input type="text" name="todate"  value="'.$toDateValue.'" readonly style="width:120px;" class=\'inputtext\' onclick="displayDatePicker(\'todate\', \'\', \'ymd\', \'-\');"  HIDEFOCUS>';
		$fromdate_todate_payment .= '</td>';
	}
	if($formname == "form3")
	{
		$fromDateValue1 = db_escape_quotes($_REQUEST['fromdate1']);
		if($fromDateValue1 == "")
			$fromDateValue1 = date("Y-m-d",time());
		$toDateValue1 = db_escape_quotes($_REQUEST['todate1']);
		if($toDateValue1 == "")
			$toDateValue1 = date("Y-m-d",time());
		$fromdate_todate_payment = '<td align="right" class="smalltxt">From Date:<br><br>To Date:</td><td>';
		$fromdate_todate_payment .= '<input type="text" name="fromdate1"  value="'.$fromDateValue1.'" readonly style="width:120px;" class=\'inputtext\' onclick="displayDatePicker(\'fromdate1\', \'\', \'ymd\', \'-\');"  HIDEFOCUS><br><br><input type="text" name="todate1"  value="'.$toDateValue1.'" readonly style="width:120px;" class=\'inputtext\' onclick="displayDatePicker(\'todate1\', \'\', \'ymd\', \'-\');"  HIDEFOCUS>';
		$fromdate_todate_payment .= '</td>';
	}
	if($formname == "form4")
	{
		$fromDateValues = date("Y-m-d");
		$fromdate_todate_payment = '<td align="right" class="smalltxt">From Date:<br><br>To Date:</td><td>';
		$fromdate_todate_payment .= '<input type="text" name="fromdate2" id="fromdate2"  value="'.$fromDateValues.'" readonly style="width:120px;" class=\'inputtext\' onclick="displayDatePicker(\'fromdate2\', \'\', \'ymd\', \'-\');"  HIDEFOCUS><br><br><input type="text" name="todate2" id="todate2" value="'.$fromDateValues.'" readonly style="width:120px;" class=\'inputtext\' onclick="displayDatePicker(\'todate2\', \'\', \'ymd\', \'-\');"  HIDEFOCUS>';
		$fromdate_todate_payment .= '</td>';
	}
echo $fromdate_todate_payment;
}
function status()
{
	global $paymentoption_followup_status;
	$sel .= '<select style="width:260px;font-family: MS Sans serif, arial, Verdana, sans-serif;font-size : 9pt" name=tstatus id=tstatus>';
	$sel .= '<option value="">--- select ---</option>';
	foreach($paymentoption_followup_status as $key=>$value)
	{
		if ($key == db_escape_quotes($_REQUEST['tstatus']))
			$selected = " selected='selected'";
		$sel .='<option value="'.$key.'" '.$selected.'>'.$value.'</option>';
		$selected = "";
	}
	$sel .= '</select>';
return $sel;
}

function getLead()
{
	global $leadsource;
	$leadtype .="<option value=''>Select</option>";
	while(list($key, $val) = each($leadsource))
	{
		if($key > 3)
		{
			$leadtype .="<option value=".$key.">".$val."</option>";
		}
	}
return $leadtype;
}
function db_escape_quotes($value)
{
	$value = db_spl_chars_encode($value);
	if (get_magic_quotes_gpc())
	{
		$value = stripslashes($value);
	}
	if (!is_numeric($value))
	{
		$value = mysql_real_escape_string($value);
	}
return trim($value);
}

function db_spl_chars_encode($str)
{
	return htmlentities($str);
}

function getDateDiff($dformat,$endDate, $beginDate)
{
	$date_parts1=explode($dformat, $beginDate);
	$date_parts2=explode($dformat, $endDate);
	$start_date=gregoriantojd($date_parts1[1], $date_parts1[2], $date_parts1[0]);
	$end_date=gregoriantojd($date_parts2[1], $date_parts2[2], $date_parts2[0]);
	return $end_date - $start_date;
}

if(($_REQUEST['submit2']) || ($_REQUEST['submit3']) )
{
	$category = $_REQUEST['linkstat'];
	$domain = $_REQUEST['domain'];

	if($_REQUEST['submit2'] != "")
		$fdate = $_REQUEST['fromdate'];
	if($_REQUEST['submit3'] != "")
		$fdate = $_REQUEST['fromdate1'];

	if($_REQUEST['submit2'] != "")
		$tdate =   $_REQUEST['todate'];
	if($_REQUEST['submit3'] != "")
		$tdate =   $_REQUEST['todate1'];

	$ts = $_REQUEST['tstatus'];
	$leadsources = $_REQUEST['lesource'];
	$countycode = $_REQUEST['countycode'];

	$applang='';
	if(is_array($domain))
	{
		if(!in_array("All",$domain))
		{
			$applang.= " AND (";
			foreach($domain as $k => $v)
			{
				if($k!=0)
					$applang.= " OR ";
				//$applang.= "Language='".$v."'";
				$domainfirst3 = $arrMatriIdPre[$v];
				$applang.= "MatriId  like '".$domainfirst3."%'";
			}
			$applang.= ")";
		}
		else
		{
			//$applang.= " and (Language = '0' or Language = '')";
		}
	}
	else if($domain != "All")
	{
		$applang.= " and Language='".$domain."'";
	}

	if(is_array($leadsources))
	{
		if(!in_array("All",$leadsources))
		{
			$applang.= " AND (";
			foreach($leadsources as $kl => $vl)
			{
				if($kl!=0)
					$applang.= " OR ";
				$applang.= "LeadSource='".$vl."'";
			}
			$applang.= ")";
		}
	}
	else if($leadsources!='All')
	{
		$applang.= " AND LeadSource='".$leadsources."'";
	}
#Country Code filter----------------------------------------------------
	if(is_array($countycode))
	{
		if(in_array('03',$countycode))
		{
			$code=implode(",",$OtherISD);
			$applang.=" AND CountryCode NOT in(".$code.")";
		}
		else if(!in_array('0',$countycode))
		{
			$comma = "";
			if(in_array('91',$countycode)) {
				$code = implode(",",$IndaiISDcode);
				$comma = ",";
			}
			if(in_array('01',$countycode)){
				$code .= $comma.implode(",",$UsaISDcode);
				$comma = ",";
			}
			if(in_array('02',$countycode)){
				$code .= $comma.implode(",",$DubaiISDcode);
				$comma = ",";
			}
			if(in_array('04',$countycode)){
				$code .= $comma.implode(",",$AustraliaISDcode);
				$comma = ",";
			}
			if(in_array('05',$countycode)){
				$code .= $comma.implode(",",$SingaporeISDcode);
				$comma = ",";
			}
			if(in_array('06',$countycode)){
				$code .= $comma.implode(",",$MalaysiaISDcode);
				$comma = ",";
			}
			if(in_array('07',$countycode)){
				$code .= $comma.implode(",",$UKISDcode);
				$comma = ",";
			}
			if(in_array('08',$countycode)){
				$code .= $comma.implode(",",$CanadaISDcode);
			}
			//$code=implode(",",$$ISDCodeArrName);
			$applang.=" AND CountryCode in(".$code.")";
		}
	}
	else
	{
		if($countycode=='03')
		{
			$code=implode(",",$OtherISD);
			$applang.=" AND CountryCode NOT in(".$code.")";
		}
		else if(($countycode!="0") && ($countycode!=""))
		{
			if($countycode=='91') {
				$ISDCodeArrName = "IndaiISDcode";
			} else if($countycode=='01'){
				$ISDCodeArrName = "UsaISDcode";
			} else if($countycode=='02'){
				$ISDCodeArrName = "DubaiISDcode";
			} else if($countycode=='04'){
				$ISDCodeArrName = "AustraliaISDcode";
			} else if($countycode=='05'){
				$ISDCodeArrName = "SingaporeISDcode";
			} else if($countycode=='06'){
				$ISDCodeArrName = "MalaysiaISDcode";
			} else if($countycode=='07'){
				$ISDCodeArrName = "UKISDcode";
			} else if($countycode=='08'){
				$ISDCodeArrName = "CanadaISDcode";
			}
			$code=implode(",",$$ISDCodeArrName);
			$applang.=" AND CountryCode in(".$code.")";
		}
	}


	if($category=="1")
	{
		if($fdate != "" && $tdate!=""){$qurydate= " and  FreshlyAddedOn>='".$fdate." 00:00:00' and FreshlyAddedOn<='".$tdate." 23:59:59'";}
		else { $qurydate= "";}
		$lable ="Total FreshProfiles:";
		$argFields = array('MatriId as cnt');
//		$argCondition = " where DateUpdated = '0000-00-00 00:00:00' and PaymentDate='0000-00-00 00:00:00' and (SupportUserName='' or SupportUserName='".$adminUserName."')  and Followupstatus=0  ".$qurydate."  ".$applang."";
//// After Suresh recommendations
		$argCondition = " where PaymentDate='0000-00-00 00:00:00' and (SupportUserName='' or SupportUserName='".$adminUserName."')  and Followupstatus=0 and LockTime < DATE_SUB(NOW(),INTERVAL 5 MINUTE) and ((EntryType='1' and PaymentDate='0000-00-00 00:00:00') or (EntryType='0' or EntryType='')) ".$qurydate."  ".$applang."";
	}
	if($category == "2")
	{
		if($fdate != "" && $tdate!=""){$qurydate= " and  FollowupDate>='".$fdate."' and FollowupDate<='".$tdate."'";}
		else { $qurydate= "";}
		$lable ="Total Followupprofiles:";
		$argFields = array('MatriId as cnt');
		//$argCondition = " where  PaymentDate='0000-00-00 00:00:00'".$qurydate." and SupportUserName='".$adminUserName."' and FollowupStatus='".$ts."' ". $applang."";
		if($ts == "1" || $ts == "9" || $ts == "10")
			$paymentDateQry = " PaymentDate != '0000-00-00 00:00:00'";
		else
			$paymentDateQry = " PaymentDate = '0000-00-00 00:00:00'";
		//$argCondition = " where $paymentDateQry ".$qurydate." and SupportUserName='".$adminUserName."' and FollowupStatus='".$ts."' ". $applang."";
	////After Suresh recommendation
		$argCondition = " where $paymentDateQry ".$qurydate." and SupportUserName='".$adminUserName."' and FollowupStatus='".$ts."' ". $applang." and ((EntryType='R' and PaymentDate='0000-00-00 00:00:00') or (EntryType='F' or EntryType=''))";

	//where ((EntryType='R' and PaymentDate='0000-00-00 00:00:00') or (EntryType='F' or EntryType=''))and FollowupDate>='2009-11-10' and FollowupDate<='2009-11-10' and SupportUserId='97' and FollowupStatus='5' order by FollowupDate desc

	}
//	echo $argCondition;
	$trec = $objSlave -> numOfRecords($varTable['PAYMENTOPTIONS'], 'MatriId', $argCondition);
	if($objSlave -> clsErrorCode != "CNT_ERR")
	{
		if($trec != 0)
		{
			$countycode = implode("~",$countycode);
			$domain = implode("~",$domain);
			$leadsources = implode("~",$leadsources);
			//if($category == "1")
			//$countdisp ="<a href=supportcheckstatus.php?category=".$category."&fdate=".$fdate."&tdate=".$tdate."&language=".$domain."&ts=".$ts."&leso=".$leadsources."&country=".$countycode." text-decoration:none;><b>".$trec."</b> &nbsp;</a>";
			//if($category == "2")
			$countdisp ="<a href=supportcheckstatus.php?category=".$category."&fdate=".$fdate."&tdate=".$tdate."&language=".$domain."&ts=".$ts."&leso=".$leadsources."&country=".$countycode." style='text-decoration:underline;'><b>".$trec."</b></a>";

		}
		else
		{
			$countdisp = 0;
		}
	}
	else
		$countdisp =  "DB Error.";

	$html = '<div id="countdisp"><table width="100%" align=center valign="top" border=0 cellpadding=4 cellspacing=1 class="normaltxt1" style="border:solid 1px #d1d1d1;">
	<tr class="rowlightbrown normaltxt1"><td colspan=2 align="right" width="50%"><b>'.$lable.'</b></td><td colspan=2 align="left"><b>'.$countdisp.'</b></td>
	</tr></table></div>';
}


if($_REQUEST['submit1'] == "submit")
{
	#GET VALUES#
	$matriId = db_escape_quotes($_REQUEST['id']);
	$leadSourcetxt = db_escape_quotes($_REQUEST['source']);
	$queueId = db_escape_quotes($_REQUEST['queueid']);
	$callerId = db_escape_quotes($_REQUEST['callerid']);
	$returnvalid = validchecking($matriId);
	if($returnvalid == "error")
	{
		$showmsg = "Error - ".mysql_error();
	}
	else if($returnvalid != 0)
	{
		$explodeReturn=explode("~",$returnvalid);
		$country = $explodeReturn[0];
////Country codes has to be take n from assusredcontact or assuredcontactbeforevalidation tables.

			$countryyycode =  $arrIsdCountryCode[$country];
		
			$argPhoneField = array('CountryCode','PhoneNo','MobileNo','PhoneNo1','AreaCode');
			$argPhoneCondition = " WHERE MatriId = '$matriId'";
			//$phoneResult = $objSlaveMatri -> select($varTable['ASSUREDCONTACT'],$argPhoneField,$argPhoneCondition,1);
			$phoneResult = $objSlaveMatri -> select($varDbInfo['DATABASE'].".".$varTable['ASSUREDCONTACT'],$argPhoneField,$argPhoneCondition,1);
//print_r($phoneResult);
			if($objSlave ->  clsErrorCode != "SELECT_ERR")
			{
				if($phoneNo == "")
					$phoneNo = $phoneResult[0]['PhoneNo'];
				if($mobileNo == "")
					$mobileNo = $phoneResult[0]['MobileNo'];
				if($assuredNo == "")
					$assuredNo = $phoneResult[0]['PhoneNo1'];
				if($areaCode == "")
				{
					$areaCode = $phoneResult[0]['AreaCode'];
					if($areaCode == "")
					{
						$assuredNo1 = explode("~",$assuredNo);
						if(count($assuredNo1) == 3)
						{
							$areaCode = $assuredNo1[1];
						}
					}
				}
				if($countryyycode == "")
				{
					$countryyycode = $phoneResult[0]['CountryCode'];
				}
			}
			else
			{
				echo "Database Error - ";
				exit;
			}
		
		
			$argPhoneField = array('CountryCode','PhoneNo','MobileNo','PhoneNo1','AreaCode');
			$argPhoneCondition = " WHERE MatriId = '$matriId'";
			//$phoneResult = $objSlaveMatri -> select($varTable['ASSUREDCONTACTBEFOREVALIDATION'],$argPhoneField,$argPhoneCondition,1);
			$phoneResult = $objSlaveMatri -> select($varDbInfo['DATABASE'].".".$varTable['ASSUREDCONTACTBEFOREVALIDATION'],$argPhoneField,$argPhoneCondition,1);
//print_r($phoneResult);
			if($objSlave ->  clsErrorCode != "SELECT_ERR")
			{
				if($phoneNo == "")
					$phoneNo = $phoneResult[0]['PhoneNo'];
				if($mobileNo == "")
					$mobileNo = $phoneResult[0]['MobileNo'];
				if($assuredNo == "")
					$assuredNo = $phoneResult[0]['PhoneNo1'];
				if($areaCode == "")
				{
					$areaCode = $phoneResult[0]['AreaCode'];
					if($areaCode == "")
					{
						$assuredNo1 = explode("~",$assuredNo);
						if(count($assuredNo1) == 3)
						{
							$areaCode = $assuredNo1[1];
						}
					}
				}
				if($countryyycode == "")
				{
					$countryyycode = $phoneResult[0]['CountryCode'];
				}
			}
			else
			{
				echo "Database Error - ";
				exit;
			}

		if($countryyycode == "")
		{
			//$countryyycode =  $arrIsdCountryCode[$country];
			/*
			$argCounty = array('Country');
			$argCountryCondition = " WHERE MatriId = '$matriId'";
			$countryResult = $objSlaveMatri -> select($varTable['MEMBERINFO'],$argCounty,$argCountryCondition,1);
			$countryyycode =  $arrIsdCountryCode[$countryResult[0][Country]];
			*/
		}
		$Paid_Status = $explodeReturn[1];
		$expiryDateTime = $explodeReturn[2];
		$expiryExp=explode(" ",$expiryDateTime);
		$expiryDate=$expiryExp[0];
		$curDate = date("Y-m-d");
		$curTime = date("H:i:s");
		$curdatetime = $curDate." ".$curTime;
		$dateDff = getDateDiff("-",$expiryDate,$curDate);

		$firstThree = substr($matriId,0,3);
		$arrMatriIdPre1 = array_flip($arrMatriIdPre);
		$communityId = $arrMatriIdPre1[$firstThree];

		if(($Paid_Status == 1 && ($dateDff >=0 && $dateDff <=10)) || ($Paid_Status == '0'))
		{
			// Setting domain id in Language column of cbssupportiface.paymentoptions table
			$first3 = substr($matriId,0,3);
			$arrMatriIdPre1 = array_flip($arrMatriIdPre);
			$language = $arrMatriIdPre1[$first3];

			//// Check matrimony if already exists in paymentoptions table.
			$args = array('MatriId');
			$argCondition = " WHERE MatriId = '".$matriId."'";
			$checkNum = $objSlave -> numOfRecords($varTable['PAYMENTOPTIONS'],'MatriId',$argCondition);

			//if($checkNum = $objSlave -> numOfRecords($varTable['PAYMENTOPTIONS'],'MatriId',$argCondition))
			if($objSlave -> clsErrorCode != "CNT_ERR")
			{
				if($checkNum > 0)
				{
					//// Update Query
					//$argFields = array('DateUpdated','Country','LeadSource','QueueId','CallerId','SupportUserName','Language','CountryCode','PaymentDate','FollowupStatus');
					//$argFieldsValues = array("'".$curdatetime."'","'".$country."'","'".$leadSourcetxt."'","'".$queueId."'","'".$callerId."'","'".$adminUserName."'","'".$language."'","'".$countryyycode."'","'0000-00-00 00:00:00'",'0');

					$argFields = array('DateUpdated','Country','LeadSource','QueueId','CallerId','SupportUserName','CountryCode','PaymentDate','FollowupStatus','PhoneNo','MobileNo','Assured_Contact_Number','CommunityId','AreaCode');
					$argFieldsValues = array("'".$curdatetime."'","'".$country."'","'".$leadSourcetxt."'","'".$queueId."'","'".$callerId."'","'".$adminUserName."'","'".$countryyycode."'","'0000-00-00 00:00:00'",'0',"'".$phoneNo."'","'".$mobileNo."'","'".$assuredNo."'","$communityId","'".$areaCode."'");

					$argCondition = " MatriId = '".$matriId."'";
					if($numUpdated = $objMaster->update($varTable['PAYMENTOPTIONS'],$argFields,$argFieldsValues,$argCondition))
					{
						if($numUpdated >= 1)
							$showmsg = 1;
						else
							$showmsg = "No rows affected while updating for Matrimony Id <b>[$matriId]</b>.";
					}
					else
						$showmsg = "Error - ".$objMaster -> clsErrorCode;
				}
				else
				{
					//// Insert Query
					//$argFields = array('MatriId','DateSelected','Country','LeadSource','QueueId','CallerId','SupportUserName','Language','CountryCode');
					//$argFieldsValue = array("'".$matriId."'","'".$curdatetime."'","'".$country."'","'".$leadSourcetxt."'","'".$queueId."'","'".$callerId."'","'".$adminUserName."'","'".$language."'","'".$countryyycode."'");

					$argFields = array('MatriId','FreshlyAddedOn','Country','LeadSource','QueueId','CallerId','SupportUserName','CountryCode','DateUpdated','PhoneNo','MobileNo','Assured_Contact_Number','CommunityId','AreaCode');
					$argFieldsValue = array("'".$matriId."'","'".$curdatetime."'","'".$country."'","'".$leadSourcetxt."'","'".$queueId."'","'".$callerId."'","'".$adminUserName."'","'".$countryyycode."'","'0000-00-00 00:00:00'","'".$phoneNo."'","'".$mobileNo."'","'".$assuredNo."'","$communityId","'".$areaCode."'");

					$numInserted = $objMaster -> insert($varTable['PAYMENTOPTIONS'], $argFields, $argFieldsValue);
					if($objMaster -> clsErrorCode != "INSERT_ERR")
					{
							$showmsg = 2;
					}
					else
					{
						$showmsg = "Error - ".$objMaster -> clsErrorCode;
					}
				}
			}
			else
				$showmsg = "Error - ".$objSlave -> clsErrorCode;
		}
		else
			$showmsg = 4;
	}
	else
		$showmsg = 3;
	$leadsourceValue = $leadsource[$leadSourcetxt];
	switch($showmsg)
	{
		case 1:
			$displayMsg = "<font color='148E22'>Lead <b>[$leadsourceValue]</b> successfully updated for Matrimony Id <b>[$matriId]</b>.  </font>";
			break;
		case 2:
			$displayMsg = "<font color='148E22'>Lead <b>[$leadsourceValue]</b> successfully entered for Matrimony Id <b>[$matriId]</b>.  </font>";
			break;
		case 3:
			$displayMsg = "<font color='E01427'>Matrimony Id <b>[$matriId]</b> is In-Valid.</font>";
			break;
		case 4:
			$displayMsg = "<font color='E01427'>Matrimony Id <b>[$matriId]</b> is a paid member. Cant update Leads again.</font>";
			break;
		case CNT_ERR:
			$displayMsg = "<font color='E01427'>Database Error .</font>";
			break;
		case INSERT_ERR:
			$displayMsg = "<font color='E01427'>Database Error - while inserting for Matrimony Id <b>[$matriId]</b>.</font>";
			break;
		case UPDATE_ERR:
			$displayMsg = "<font color='E01427'>Database Error - while updating for Matrimony Id <b>[$matriId]</b>.</font>";
			break;
		default:
			$displayMsg = "$showmsg .";
	}
	//$headerPara = 'location: successleadmsg.php?task='.$showmsg.'&mid='.$matriId;
	//header($headerPara);
}

?>
<html>
<head>
	<title><?=$confPageValues['PAGETITLE']?></title>
	<meta name="description" content="<?=$confPageValues['PAGEDESC']?>">
	<meta name="keywords" content="<?=$confPageValues['KEYWORDS']?>">
	<meta name="abstract" content="<?=$confPageValues['ABSTRACT']?>">
	<meta name="Author" content="<?=$confPageValues['AUTHOR']?>">
	<meta name="copyright" content="<?=$confPageValues['COPYRIGHT']?>">
	<meta name="Distribution" content="<?=$confPageValues['DISTRIBUTION']?>">
	<link rel="stylesheet" href="<?=$confValues['CSSPATH']?>/global-style.css">
	<link rel="stylesheet" href="<?=$confValues['CSSPATH']?>/usericons-sprites.css">
	<link rel="stylesheet" href="<?=$confValues['CSSPATH']?>/useractions-sprites.css">
	<link rel="stylesheet" href="<?=$confValues['CSSPATH']?>/useractivity-sprites.css">
	<link rel="stylesheet" href="<?=$confValues['CSSPATH']?>/messages.css">
	<link rel="stylesheet" href="<?=$confValues['CSSPATH']?>/fade.css">

<title>Payment</title>
<SCRIPT type="text/javascript" src="../includes/calender.js"></script>
<SCRIPT type="text/javascript" src="../includes/calenderJS.js"></script>

<script language="javascript" type="text/javascript">


function createRequestObject(){
	var request_o; //declare the variable to hold the object.
	var browser = navigator.appName; //find the browser name
	if(browser == "Microsoft Internet Explorer"){
		/* Create the object using MSIE's method */
		request_o = new ActiveXObject("Microsoft.XMLHTTP");
	}else{
		/* Create the object using other browser's method */
		request_o = new XMLHttpRequest();
	}
	return request_o; //return the object
}


var http = createRequestObject();




function hidephone(leadstat)
{
	if(leadstat=='4')
	{
		document.getElementById("showcaller").style.display = "inline";
		document.getElementById("showqueue").style.display = "inline";
	}
	else if(leadstat=='5')
	{
		document.getElementById("showcaller").style.display = "inline";
		document.getElementById("showqueue").style.display = "none";
	}
	else
	{
		document.getElementById("showcaller").style.display = "none";
		document.getElementById("showqueue").style.display = "none";
	}
}
function freshprofile(linkvalue,count)
{
	if(linkvalue == 1)
	{
		document.getElementById('freshprofile').style.display="";
		document.getElementById('followup').style.display="none";
		document.getElementById('eprdiv').style.display = "none";
		document.getElementById("eprResult").style.display = "none";
		document.getElementById(count).style.display="none";
	}
	if(linkvalue == 2)
	{
		document.getElementById('freshprofile').style.display="none";
		document.getElementById('followup').style.display="";
		document.getElementById('eprdiv').style.display = "none";
		document.getElementById("eprResult").style.display = "none";
		document.getElementById(count).style.display="none";
	}
}
 function validate_required(field,alerttxt){
     with (field){
      if (value==null||value=="") {alert(alerttxt);return false;
	  }else {return true;
	  }
     }
   }
function validate_form(thisform)
{
   with (thisform)
   {
		if (name=="form1")
		{
			if (validate_required(id,"Matrimony id field must be filled!")==false)
			{
				id.focus();
				return false;
			}
			else if(validate_required(source,"Lead Source field must be Selected !")==false)
			{
				source.focus();
				return false;
			}
			if(document.getElementById('showqueue').style.display != "none")
			{
				if(isNaN(document.getElementById('queueid').value) == true || document.getElementById('queueid').value.length > 6)
				{
					alert("In-Valid Queue Id !!");
					document.getElementById('queueid').focus();
					return false;
				}
			}
			if(document.getElementById('showcaller').style.display != "none")
			{
				if(isNaN(document.getElementById('callerid').value) == true || document.getElementById('callerid').value.length > 20)
				{
					alert("In-Valid Caller Id !!");
					document.getElementById('callerid').focus();
					return false;
				}
			}
		}
	}
}
function viewbyid()
{
	document.getElementById("vubymatidid").innerHTML = "";
	var matid = document.getElementById('mtid').value;
	if (matid == "")
	{
		document.getElementById("vubymatidid").innerHTML = "<center><font color='red' class='smalltxt'>Please Enter a Matrimony Id</font></center>";
	return false;
	}
	else
	{
		rnd = Math.random();
		http.open('get','checkMatriId.php?mtid='+matid+'&rnd='+rnd,true);

		http.onreadystatechange = function(){
			if(http.readyState == 1){document.getElementById("vubymatidid").innerHTML = "<center><font color='#000000' class='smalltxt'>Checking Matrimony Id ...</font></center>";}
			if(http.readyState == 4){
				if (http.status == 200)	{
				var response = http.responseText;
				//alert(response);
					if(response == 0 || response == "") {
						document.getElementById("vubymatidid").innerHTML = "<font color='red' class='smalltxt'>In-Valid Matrimony Id or not viewable</font>";
						return false;
					}
					else if(response == "Error") {
						document.getElementById("vubymatidid").innerHTML = "<font color='red' class='smalltxt'>Error , please submit again...</font>";
						return false;
					}
					else {
					//document.getElementById("vubymatidid").innerHTML = " "+response;
					//return false;
					document.getElementById("vubymatidid").innerHTML = "<center><font color='red' class='smalltxt'>Redirecting ...</font></center>";
					document.viewbyidfrm.action="supportcheckstatus.php?category="+document.getElementById('category').value+"&mtid="+document.getElementById('mtid').value;
					document.viewbyidfrm.submit();
					}
				}
			}
		}
		http.send(null);
		//document.viewbyidfrm.submit();
	}
	return true;
}

function openCenteredWindow(url) {
    var width = 800;
    var height = 350;
    var left = parseInt((screen.availWidth/2) - (width/2));
    var top = parseInt((screen.availHeight/2) - (height/2));
    var windowFeatures = "width=" + width + ",height=" + height + ",status,resizable,left=" + left + ",top=" + top + "screenX=" + left + ",screenY=" + top;
    myWindow = window.open(url, "todayreport", windowFeatures);
	return false;
}
</script>

</head>
<body>
<table align=center border='0' cellpadding='0' cellspacing='0'  width='800' style='border: 1px solid #d1d1d1;'>
<tr><td height="50">
<?php
include("../home/header.php");
?>
</td></tr>
    <tr>
	<td height=30  class="adminformheader">&nbsp;&nbsp;<b>Support Interface</td>
    <td height=30 align=center  class="adminformheader">&nbsp;<a href='index.php'><b>Home</a></td>
	<!-- <td height=30 align=center  class="adminformheader"><a href="../index.php?act=logout"><b>Logoff</a></td> -->
    </tr>
	</table>

<table cellpadding="0" cellspacing="0" align="center" width="80%">
<tr><td colspan="2">
<?php
//	include_once("../home/header.php");
?>
</td></tr>
<tr>
<td width="25%" valign="top">
<?php
	include_once("../home/left-menu.php");
?>
</td>
<td valign="top">
<center class="adminformheader">PAYMENT ASSISTANCE</center>

 <table width="100%" align=center valign="top" border="0" cellpadding=0 cellspacing=0 class="normaltxt1" style="border-left:solid 1px #d1d1d1;border-right:solid 1px #d1d1d1;">
 <tr ><td class="normaltxt1 clr6" colspan="4" align="center"><?php echo $displayMsg; ?></td></tr>
<tr><td valign="top" width="50%" style="border-right:solid 1px #d1d1d1;">
 <form method="POST" name="form1" action="" onsubmit="return validate_form(this)">
 <input name="" type="t" value="" style="display:none">
 <table width="100%" align=center valign="top" border="0" cellpadding=4 cellspacing=0 class="normaltxt1">
 	<tr class="rowlightbrown normaltxt1">
		<td align="center" colspan="2"><b>Submit Lead Source</b></td>
	</tr>
	<tr>
		<td align="right" width="37%" class="smalltxt">Matrimony Id:</td><td width="63%"><input type="text" name="id" maxlength=9 class="inputtext"></td>
	</tr>
	<tr>
		<td align="right" class="smalltxt">Lead  Source:</td><td>
		<select name="source" size="1" onchange='hidephone(this.value);' class="select">
		 <?echo getLead();?>
		</select>
		</td>
	</tr>

	<tr>
		<td colspan='2' align="center" width="100%">
		 		<!--<div id="showqueue" style="display:none;padding-left:2px;"> -->
				<table align='center' width="100%" border='0' id="showqueue" style="display:none;">
					<tr align="right">
						<td width="28%" class="smalltxt">Queue&nbsp;Id&nbsp;:&nbsp;&nbsp;</td>
						<td width="72%" align="left">&nbsp;<input type="text" name="queueid" id="queueid" maxlength='6' class="inputtext"></td>
					</tr>
				</table>
				</div>
				<!--<div id="showcaller" style="display:none;padding-left:2px;"> -->
				<table align='center' width="100%" border='0' id="showcaller" style="display:none;">
					<tr align="right" >
						<td width="28%" class="smalltxt">Caller&nbsp;Id&nbsp;:&nbsp;&nbsp;</td>
						<td width="72%" align="left"><input type="text" name="callerid" id="callerid" maxlength='20' class="inputtext"></td>
					</tr>
				</table>
				</div>
		</td>
	</tr>
	<tr><td colspan=2 align="center"><input type="submit" name="submit1" class="button" value="submit"></td>
	</tr>
	<tr><td><div id="submitsta1"></div></td></tr>
	</table>
	</form>
</td><td valign="top" width="50%">
<script type="text/javascript">
function allowClick(e){
var unicode=e.charCode? e.charCode : e.keyCode
	if (unicode == 13){
		alert("Click the submit buton to Submit..");
		return false;
	}
}
</script>
	<form method="GET" name="viewbyidfrm" action="">
	 <table width="100%" align=center valign="top" border="0" cellpadding=4 cellspacing=1 class="normaltxt1">
	 	<tr class="rowlightbrown normaltxt1">
		<td colspan=4 align="center" valign="top"><b>View By MatriId</b></td>
	</tr>
	<tr>
		<td colspan=4 align="center" valign="top" id="vubymatidid" class="normaltxt1 clr6"></td>
	</tr>
	<tr>
		<td colspan=4 align="center" width="100%" class="smalltxt" valign="top">View by MatriId <input type="hidden" name="category" id="category" value=3><input type="text" name="mtid" id="mtid" class="inputtext" onkeypress="return allowClick(event);">&nbsp;&nbsp;<input type="button" name="vibyid" value="submit" class="button" onClick="viewbyid();"></td>
	</tr>
	<tr><td></td></tr>
	</table>
	</form>
</td></tr>

 </table>




<table width="100%" align=center valign="top" border=0 cellpadding=4 cellspacing=1  class="adminformheader" style="border:solid 1px #d1d1d1;">
	<tr class="rowlightbrown normaltxt1">
		<td align="center" width="20%"><a href="javascript:freshprofile(1,'countdisp');" >FreshProfile</a></td>
		<td align="center" width="20%"><a href="javascript:freshprofile(2,'countdisp');">FollowupStatus</a></td>
		<td align="center" width="20%"><a href="supportgetreport.php" onClick="openCenteredWindow(this.href);return false;">Today Report</a></td>
		<td align="center" width="20%"><a href="supportcheckstatus.php?category=4" target="_self">Pending Profiles</a></td>
		<td align="center" width="20%"><a onClick='return showEPR();'>EPR Status</a></td>
	</tr>
</table>
<script language="javascript" type="text/javascript">
function showEprStatusForm(fromform)
{
	document.getElementById('freshprofile').style.display = "none";
	document.getElementById('followup').style.display = "none";
	if(fromform == "1")
	{
		if(document.getElementById('epr'))
		{
			var epr = document.getElementById('epr').value;
			if(epr == "")
			{
				alert("Enter EPR Number");
				document.getElementById('epr').focus();
				return false;
			}
		}
		else
		{
			epr = "";
		}
	}
	var fromdate = document.getElementById('fromdate2').value;
	var todate = document.getElementById('todate2').value;
	rnd = Math.random();
	http.open('get','eprstatus.php?epr='+epr+'&fromform='+fromform+'&fromdate='+fromdate+'&todate='+todate+'&rnd='+rnd,true);

	http.onreadystatechange = function()
	{
		if(http.readyState == 1){document.getElementById("eprResult").innerHTML = "<font color='#000000' class='smalltxt'>Checking EPR Status ...</font>";}
		document.getElementById('eprdiv').style.display="";
		if(http.readyState == 4)
		{
			if (http.status == 200)
			{
				var response = http.responseText;
				document.getElementById("eprResult").style.display = "block";
				document.getElementById("eprResult").innerHTML = ""+response;
			}
		}
	}
	http.send(null);		
	//document.getElementById('epr').focus();
return false;
}
</script>
<script language="javascript" type="text/javascript">
function showEPR()
{
	document.getElementById('freshprofile').style.display="none";
	document.getElementById('followup').style.display="none";
	document.getElementById('eprdiv').style.display = "block";
	document.getElementById("eprResult").style.display = "block";
	document.getElementById('epr').focus();
}
</script>
<div id='eprdiv' style='display:none;'>
	<table width="100%" align=center valign="top" border=0 cellpadding=4 cellspacing=1 class="normaltxt1" style="border:solid 1px #d1d1d1;">
	<tr class="rowlightbrown normaltxt1"><td colspan=4 align="center"><b>EPR Status</b></td></tr>
	<tr>
	<td width='50%'>
		<table cellpadding='3' cellspacing='0' align='center' width='100%' border='0'>
		<tr><td><? fromdate_todate_payment('form4');?></td></tr>
		<tr><td align='center' colspan='3'><input type='button' name='submit' value='Submit' onClick='return showEprStatusForm("2");' class='button'></td></tr>
		</table>
	</td>
	<td class='smalltxt'>EPR Number : <input type='text' name='epr' id='epr' value='' class='inputtext'> &nbsp; &nbsp; <input type='button' name='submit' value='Submit' onClick='return showEprStatusForm("1");' class='button'></td></tr>
	</table>
<br><br>
<!--
	<table cellpadding='0' cellspacing='0' align='center' width='90%'>
	<tr><td><input type='text' name='epr' id='epr' value=''> &nbsp; &nbsp; <input type='button' name='submit' value='Submit' onClick='return showEprStatusForm("2");' class='button'></td></tr>
	</table>
-->
</div>
<div id='eprResult'></div>
<? if($_REQUEST['submit2']){$outstyle = ""; }else{$outstyle = "display:none;";}?>
<div id="freshprofile" style="<?=$outstyle?>">

<!---<form method="post" name="form2" action="supportpaymentoptions.php" onsubmit="return validate_form(this)"> --->
<form method="post" name="form2" action="index.php" onsubmit="return validate_form(this)">
<table width="100%" align=center valign="top" border=0 cellpadding=4 cellspacing=1 class="normaltxt1" style="border:solid 1px #d1d1d1;">
	<tr class="rowlightbrown normaltxt1"><td colspan=4 align="center"><b>Show Payment Option Details</b></td></tr>
	<tr>
		<td align="right" width="20%" class="smalltxt">Select Domain:</td><td width="30%"><? //showrecords();?><?=showDomains(); ?></td><td align="right" width="20%" class="smalltxt">Lead Source:</td><td width="30%">
		<?php
		$lsource="<select id=lesource name=lesource[] size=3 multiple class='select'>";
		$lsource.="<option value='All'";
		if(is_array($_REQUEST['lesource'])) {
			if (in_array("All",$_REQUEST['lesource'])){
				$lsource .=' selected ';
			}
		} else {
			if (($_REQUEST['lesource']=="All")||($_REQUEST['lesource']=="")){
				$lsource .=' selected ';
			}
		}
		$lsource.=">All</option>";
		foreach($leadsource as $lkey=>$lvalue) {
		$lsource.="<option value='$lkey' ";
		if(is_array($_POST['lesource']))
			if(in_array($lkey,$_POST['lesource'])) {
				$lsource.="selected ";
			}
		else if($lkey==$_POST['lesource']) {
				$lsource.="selected ";
			}
		$lsource.=">$lvalue</option>";
		}
		$lsource.="</select>";
		echo $lsource;
		?>
		</td>
	</tr>

	<tr>
		<td align="right" class="smalltxt">Country:</td><td>
		<?php
		$county="<select id=countycode name=countycode[] size=3 multiple class='select'>";
		$county.="<option value='0'";
		if(is_array($_REQUEST['countycode'])) {
			if (in_array("0",$_REQUEST['countycode'])){
				$county .=' selected ';
			}
		} else {
			if (($_REQUEST['countycode']=="0")||($_REQUEST['countycode']=="")){
				$county .=' selected ';
			}
		}
		$county.=">All</option>";
		foreach($countries as $ckey=>$cvalue) {
			$county.="<option value='$ckey' ";
			if(is_array($_POST['countycode']))
				if(in_array($ckey,$_POST['countycode'])) {
					$county.="selected ";
				}
			else if($ckey==$_POST['countycode']) {
					$county.="selected ";
				}
			$county.=">$cvalue</option>";
		}
		$county.="</select>";
		echo $county;
		?>
		</td><? fromdate_todate_payment('form2');?>
	</tr>
	<tr><input type="hidden" name="linkstat" value="1">
		<td colspan="4" align="center">
		<input type="submit" name="submit2" value="Show Data" class="button"> &nbsp; <input type="button" value="Clear" class="button" onClick="window.location.href='<?php echo $_SERVER[PHP_SELF]; ?>'">
		</td>
	</tr>
</table>
</form>
</div>
<?
	if($_REQUEST['submit3']){$outstyle = ""; }else{	$outstyle = "display:none;";}
?>
	<div id="followup" style="<?=$outstyle?>">
      <form method="post" name="form3" action="index.php" onsubmit="return validate_form(this)">
	  <table width="100%" align=center valign="top" border=0 cellpadding=4 cellspacing=1 class="normaltxt1" style="border:solid 1px #d1d1d1;">
	  <tr class="rowlightbrown normaltxt1">
		<td colspan=4 align="center"><b>Show Payment Option Details</b></td></tr>
	<tr><td width="20%" align="right" class="smalltxt">Select Domain:</td><td width="30%"><?//showrecords();?><?=showDomains(); ?></td><td width="20%" align="right" class="smalltxt">Lead Source:</td><td width="30%">
		<?php
		$lsource="<select id=lesource name=lesource[] size=3 multiple class='select'>";
		$lsource.="<option value='All'";
		if(is_array($_REQUEST['lesource'])) {
			if (in_array("All",$_REQUEST['lesource'])){
				$lsource .=' selected ';
			}
		} else {
			if (($_REQUEST['lesource']=="All")||($_REQUEST['lesource']=="")){
				$lsource .=' selected ';
			}
		}
		$lsource.=">All</option>";
		foreach($leadsource as $lkey=>$lvalue) {
		$lsource.="<option value='$lkey' ";
		if(is_array($_POST['lesource']))
			if(in_array($lkey,$_POST['lesource'])) {
				$lsource.="selected ";
			}
		else if($lkey==$_POST['lesource']) {
				$lsource.="selected ";
			}
		$lsource.=">$lvalue</option>";
		}
		$lsource.="</select>";
		echo $lsource;
		?>
		</td>
	</tr>
	<tr>
	<td align="right" class="smalltxt">Country:</td><td>
	<?php
		$county="<select id=countycode name=countycode[] size=3 multiple class='select'>";
		$county.="<option value='0'";
		if(is_array($_REQUEST['countycode'])) {
			if (in_array("0",$_REQUEST['countycode'])){
				$county .=' selected ';
			}
		} else {
			if (($_REQUEST['countycode']=="0")||($_REQUEST['countycode']=="")){
				$county .=' selected ';
			}
		}
		$county.=">All</option>";
		foreach($countries as $ckey=>$cvalue) {
			$county.="<option value='$ckey' ";
			if(is_array($_POST['countycode']))
				if(in_array($ckey,$_POST['countycode'])) {
					$county.="selected ";
				}
			else if($ckey==$_POST['countycode']) {
					$county.="selected ";
				}
			$county.=">$cvalue</option>";
		}
		$county.="</select>";
		echo $county;
	?>
	</td><? fromdate_todate_payment('form3'); ?>
	</tr>
   	<tr>
		<td colspan=4  align="center" class="smalltxt">View By Followup Status:&nbsp;&nbsp;&nbsp;<?=status();?></td></tr>
	<tr><input type="hidden" name="linkstat" value="2">
		<td colspan=4 align="center">
		<input type="submit" name="submit3" value="Show Data" class="button"> &nbsp; <input type="button" value="Clear" class="button" onClick="window.location.href='<?php echo $_SERVER[PHP_SELF]; ?>'">
		</td>
	</tr>
</table>
</form>
</div>
<?php
	echo $html;
?>
</td></tr>
</table>
</body>
</html>
<?php
//$objSlaveMatri->dbClose();
$objSlave->dbClose();
$objMaster->dbClose();

//UNSET($objSlaveMatri);
UNSET($objSlave);
UNSET($objMaster);
?>